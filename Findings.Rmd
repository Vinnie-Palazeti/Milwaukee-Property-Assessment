---
title: "Findings"
output: html_document
---

Final

Research Question

Background on Dependent variable - Assessment Ratio


Data Provided
```{r}
setwd("C:/Users/Vinnie/Documents")
load("res_data_w_geo.dta")
Initial <-data.frame(res_data_w_geo)
print(Initial)
```
All variables
```{r}
names(Initial)
```

Continuous Variables of Interest

Sale Price, Land Size, Land Value, Improvement Value, Assessment Value
```{r}
ggplot(Initial, aes(SALEPRICE)) +
  geom_histogram(bins = 200)

ggplot(Initial, aes(ASSESSEDVAL)) +
  geom_histogram(bins = 200)

ggplot(Initial, aes(LANDSIZE)) +
  geom_histogram(bins = 200)

ggplot(Initial, aes(LANDVAL)) +
  geom_histogram(bins = 200)

Initial$atsratio <- Initial$ASSESSEDVAL / Initial$SALEPRICE

ggplot(Initial, aes(atsratio)) +
  geom_histogram(bins = 200)

```


We first look at the main variables of interest & discover that they are all extremely right tailed.

We know from prior knowledge that this would be the case. Many weird sales/properties exist, e.g. donations, auctions, foreclosures, condemtions. 

In an attempt to remedy this we remove the observations outside the interquartile range


Look at effect of this change on distribution of ats ratio

```{r}
ggplot(resdata, aes(atsratio)) +
  geom_histogram(bins = 200)


ggplot(resdata, aes(log(SALEPRICE))) +
  geom_histogram(bins = 150)

ggplot(resdata, aes(log(ASSESSEDVAL))) +
  geom_histogram(bins = 150)
```



Categorical Variables

Building Type, Building Quality, Number of Buildings, Building Condition, Bedrooms, Kitchens, Baths, Half-Baths, Garages
```{r}
BLDFreqs <- resdata %>% group_by(BLDTYPE) %>% summarize(n = n())
plotgroup <- resdata %>% left_join(BLDFreqs, by = c("BLDTYPE"))

ggplot(filter(plotgroup, n > 400), aes(BLDTYPE)) +
  geom_bar() #+ theme(axis.text.x = element_blank())

level_order_qual <- c("A","B","C","D","E","NA")

ggplot(resdata, aes(x = factor(QUAL, level = level_order_qual))) +
  geom_bar()# + theme(axis.text.x = element_blank())

level_order_cond <- c("EX - Excellent","VG - Very Good","GD - Good","AV - Average","FR - Fair","PR - Poor","VP - Very Poor","UN - Unsound")

ggplot(resdata, aes(x = factor(COND, level = level_order_cond))) +
  geom_bar()# + theme(axis.text.x = element_blank())

ggplot(resdata, aes(NUM_BLDS)) +
  geom_bar()

ggplot(resdata, aes(KITCHENS)) +
  geom_bar()

ggplot(resdata, aes(BEDROOMS)) + 
  geom_bar()
```


Temporal Variables

Date sold, Year Built
```{r}
ggplot(resdata, aes(SALEDATE,fill = factor(QUAL_recode, level = level_order_qual))) +
  geom_histogram(bins=100) +
  theme(legend.title=element_blank())

ggplot(resdata, aes(YEARBLT, fill = factor(QUAL_recode, level = level_order_qual))) +
  geom_histogram(bins=100) +
  theme(legend.title=element_blank())

ggplot(resdata, aes(YEARBLT, fill = factor(COND, level = level_order_cond))) +
  geom_histogram(bins=100)

```


Visualizations of variables with ats ratio

```{r}
ggplot(resdata, aes(atsratio, fill = factor(QUAL_recode, level = level_order_qual))) +
  geom_histogram(bins=100) +
  theme(legend.title=element_blank())


ggplot(resdata, aes(atsratio, fill = factor(COND, level = level_order_cond))) +
  geom_histogram(bins=100)+
  theme(legend.title=element_blank())
```



Population analysis 

Census Data visualizations

Shapefile
```{r}
Mil_County<-st_read("C:/Users/Vinnie/Desktop/GitHub/Milwaukee-Property-Assessment/Shapefiles/Census_Tracts.shp")
#Makeup
st_geometry_type(Mil_County)
#Coordinate Reference System
st_crs(Mil_County)
#World Geodetic System 1984

`%notin%` <- Negate(`%in%`)

Mil_County2 <- Mil_County %>%
  filter(OBJECTID %notin% c(263)) %>%
  rename(GEO_TRACT = Tract_ID_I)

Mil_County3 <- st_crop(Mil_County2,xmin=-88.06995, xmax=-87.81955, ymin=42.92, ymax=43.19259)

Remove <- setdiff(Mil_County2$GEO_TRACT,resdata$GEO_TRACT)

Mil_County4 <- Mil_County3 %>% 
  left_join(resdata, by = "GEO_TRACT") %>%
  mutate(lighter = ifelse(GEO_TRACT %in% Remove, 1,0))

lighter_color <- Mil_County4 %>% filter(lighter==1)

ggplot() + 
  geom_sf(data = Mil_County4, color = "black", fill = "pink") + 
  ggtitle("Milwaukee!") + 
  coord_sf()


```


Racial population distribution

In stark relief 

```{r}
ggplot() + 
  geom_sf(aes(fill=Percent_Black), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent Black')+
  ggtitle("Milwaukee Census Tracts by Percent Black Population") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()


ggplot() + 
  geom_sf(aes(fill=Percent_NotHispanic_White), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent White')+
  ggtitle("Milwaukee Census Tracts by Percent White Population") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()

ggplot() + 
  geom_sf(aes(fill=Percent_Hispanic), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent Hispanic')+
  ggtitle("Milwaukee Census Tracts by Percent Hispanic Population") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()
```

Socio-Economic Population distribution 

```{r}
ggplot() + 
  geom_sf(aes(fill=IncomeDecile), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Income Decile')+
  ggtitle("Milwaukee Census Tracts by Income Deciles") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()


ggplot() + 
  geom_sf(aes(fill=Percent_Renter), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent Renter')+
  ggtitle("Milwaukee Census Tracts by Percent Renter") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()

ggplot() + 
  geom_sf(aes(fill=renterdecile), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent Renter Deciles')+
  ggtitle("Milwaukee Census Tracts by Percent Renter Deciles") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()


ggplot() + 
  geom_sf(aes(fill=Percent_TotalPOPIncomeBelowPovRate), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent of Population')+
  ggtitle("Milwaukee Census Tracts by Percent Population with Income Below Poverty Rate") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()

```



```{r}

ggplot() + 
  geom_sf(aes(fill=atsratiodecile), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='ATS Ratio Decile')+
  ggtitle("Milwaukee Census Tracts by ATS Ratio Decile") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()

ggplot() + 
  geom_sf(aes(fill=atsratioMedian), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='ATS Ratio Decile')+
  ggtitle("Milwaukee Census Tracts by ATS Ratio Decile") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()


```


We very plainly see patterns



Next we go into Pre Regression Analysis

First with Racial Demographics

    
Median ATS Ratio by Percent Black Population Decile
```{r}
blackpop <- tapply(resdata$atsratio,resdata$blackdecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(blackpop[[i]]['Median']) }

BlackATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(BlackATS)
tapply(resdata$atsratio,resdata$blackdecile, summary)
```

    - The Median Assessment to Sale ratio decreases as the percent black population increases
    
    - As the percent of the black population increases in a tract, the assessment diverges from the sale value of the house
    
    - Homes in black neighborhoods are under assessed 
    
    
Median ATS Ratio by Percent White Population Decile
```{r}

whitepop <- tapply(resdata$atsratio,resdata$white_nonhispanic_decile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(whitepop[[i]]['Median']) }

WhiteATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(WhiteATS)
tapply(resdata$atsratio,resdata$white_nonhispanic_decile, summary)
```

    - The Median Assessment to Sale ratio increases as the percent white population increases
    
    - As the percent of the white population increases in a tract, the assessment approaches the sale value of the house
    
    - Homes in white neighborhoods are over assessed (relative to black neighborhoods), homes are assessed closer to their true sale value
    
    - Homes in white neighborhoods show the opposite trend to black neighborhoods
    

    
Median ATS Ratio by Percent Hispanic Population Decile
```{r}
hispanicpop <- tapply(resdata$atsratio, resdata$hispaniddecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(hispanicpop[[i]]['Median']) }

HispATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(HispATS)
tapply(resdata$atsratio, resdata$hispaniddecile, summary)

```


    - See less of a trend here
    
  
Median ATS Ratio by Income Decile
```{r}
incomes <- tapply(resdata$atsratio,resdata$IncomeDecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(incomes[[i]]['Median']) }

IncomeATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)



print(IncomeATS)
tapply(resdata$atsratio,resdata$IncomeDecile, summary)
```

    - The Median Assessment to Sale ratio increases as the Median Income of the tract Increase
    
    - As the income increases, the assessment approaches the sale value of the house
    


Median ATS Ratio by Sales Decile
```{r}
sales <- tapply(resdata$atsratio,resdata$salesdecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(sales[[i]]['Median']) }

SaleATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(SaleATS)
tapply(resdata$atsratio, resdata$salesdecile, summary)

```

    - The Median Assessment to Sale ratio decreases as the sale price increases
    
    - As the sale price of a house increases, the assessment diverges from the sale value of the house
    
    - Higher prices homes are under assessed  
    
  
Median ATS Ratio by Percent Population with Income Below Poverty Rate
```{r}
pov <- tapply(resdata$atsratio,resdata$TotalPOPIncome_PovertyRateDecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(pov[[i]]['Median']) }

PovATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(PovATS)
tapply(resdata$atsratio,resdata$TotalPOPIncome_PovertyRateDecile, summary)

```

Median ATS Ratio by Percent Renter Population
```{r}
renter <- tapply(resdata$atsratio,resdata$renterdecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(renter[[i]]['Median']) }

RentATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(RentATS)
tapply(resdata$atsratio,resdata$renterdecile, summary)
```

Mann Kendall Trend Test

This is a test for monotonic trend
```{r}
cat("Black Population Deciles","\n")
MannKendall(BlackATS$Medians)
cat("---","\n")

cat("White Population Deciles","\n")
MannKendall(WhiteATS$Medians)
cat("---","\n")

cat("Hispanic Population Deciles","\n")
MannKendall(HispATS$Medians)
cat("---","\n")

cat("Income Deciles","\n")
MannKendall(IncomeATS$Medians)
cat("---","\n")

cat("Sale Price Deciles","\n")
MannKendall(SaleATS$Medians)
cat("---","\n")

cat("Renter Population Deciles","\n")
MannKendall(RentATS$Medians)
cat("---","\n")

cat("Poverty Rate Deciles","\n")
MannKendall(PovATS$Medians)
```

Black, White, Income, Sale, & Poverty are found to have Monotonic trends

Renter & Hispanic are found to not have Monotonic trends


Assessing Correlations

Consider large correlation plot of all variables needed for regression

Tract Level Variables & Observation Level Variables

Correlations
```{r}

Observation_independents <- resdata %>% 
  select(atsratio,SALEPRICE,YEARBLT,LANDSIZE, SaleYear,SaleMonth,ASSESSEDVAL, Kitchen_Average, Kitchen_Excellent, Kitchen_Fair, Kitchen_Good, Kitchen_Poor, Kitchen_VeryGood, Kitchen_VeryPoor, KITCHENS, FullBath_Average,FullBath_Excellent,FullBath_Fair,FullBath_Good,FullBath_Poor,FullBath_VeryGood,FULLBATHS, Cond_VeryPoor,Cond_Average,Cond_Excellent,Cond_Fair,Cond_Good,Cond_Poor,Cond_VeryGood, Qual_A,Qual_B,Qual_C,Qual_C,Qual_D,Qual_E, BEDROOMS, Ranch,Cape_Cod,Milwaukee_Bungalow,Res_OS_A,Colonial,Duplex,Res_OS_2sty,Other)

Obs_cors <- cor(Observation_independents)

corrplot(Obs_cors,method='circle', type = 'lower', tl.col="black")


Tract_independents <- resdata  %>% select(GEO_TRACT,MedianATSRatio,MEDIAN.INCOME,Percent_Black,Percent_NotHispanic_White,Percent_Hispanic,Percent_TotalPOPIncomeBelowPovRate)

Tract_independents <- Tract_independents %>% 
  select(-c(GEO_TRACT))

Tract_cors <- cor(Tract_independents)

corrplot(Tract_cors,method='circle', type = 'lower', tl.col="black")
```


In a crude way we can check the relationship between correlated variables via R^2

```{r}

summary(lm(MEDIAN.INCOME ~ Percent_Black, data = resdata))
plot(lm(MEDIAN.INCOME ~ Percent_Black, data = resdata))

ggplot(resdata, aes(x = Percent_Black, y = MEDIAN.INCOME)) +
  geom_point()

ggplot(resdata, aes(x = Percent_Black, y = MEDIAN.INCOME)) +
  geom_point() +
  geom_smooth(method = lm)



summary(lm(MEDIAN.INCOME ~ Percent_NotHispanic_White, data = resdata))
plot(lm(MEDIAN.INCOME ~ Percent_NotHispanic_White, data = resdata))

ggplot(resdata, aes(x = Percent_NotHispanic_White, y = MEDIAN.INCOME)) +
  geom_point()

ggplot(resdata, aes(x = Percent_NotHispanic_White, y = MEDIAN.INCOME)) +
  geom_point() +
  geom_smooth(method = lm)



summary(lm(MEDIAN.INCOME ~ Percent_Hispanic, data = resdata))
plot(lm(MEDIAN.INCOME ~ Percent_NotHispanic_White, data = resdata))

ggplot(resdata, aes(x = Percent_Hispanic, y = MEDIAN.INCOME)) +
  geom_point()

ggplot(resdata, aes(x = Percent_Hispanic, y = MEDIAN.INCOME)) +
  geom_point() +
  geom_smooth(method = lm)

```


PARTIAL CORRELATION
 
LASSO

BEST SUBSET


 
Regression Analysis

```{r}

fitdata <- resdata %>% 
  select(atsratio,
         Percent_Black,Percent_Renter,Percent_TotalPOPIncomeBelowPovRate,
         PctSalePriceDiff_Below,PctSalePriceDiff_Above,PctSalePriceDiff_Below,
         LogMedianIncome,LogMedianTractSalesPrice,GEO_TRACT)
 
scaled.dat <- fitdata %>% 
  select(-c("GEO_TRACT")) %>% scale(center = T,scale=T)

fitdata <- as.data.frame(scaled.dat) %>% 
  mutate(GEO_TRACT = fitdata$GEO_TRACT)

covariates <- resdata %>% select(Kitchen_Excellent, Kitchen_Fair, Kitchen_Good, Kitchen_Poor, Kitchen_VeryGood, Kitchen_VeryPoor, KITCHENS,FullBath_Excellent,FullBath_Fair,FullBath_Good,FullBath_Poor,FullBath_VeryGood,FULLBATHS, Cond_VeryPoor,Cond_Excellent,Cond_Fair,Cond_Good,Cond_Poor,Cond_VeryGood, Qual_A,Qual_B,Qual_D,Qual_E, BEDROOMS,Cape_Cod,Milwaukee_Bungalow,Res_OS_A,Colonial,Duplex,Res_OS_2sty,Other)


fitdata <- cbind(fitdata,covariates)



mod1 <- lmer(atsratio ~ LogMedianIncome + Percent_Black + Percent_Renter + Percent_TotalPOPIncomeBelowPovRate + LogMedianTractSalesPrice  + PctSalePriceDiff_Above + PctSalePriceDiff_Below + (1|GEO_TRACT), data = fitdata)

# RF source of variability
# if GEOtract as fixed effect, losing df
# only loosing 1 df with RF, 

summary(mod1)
anova(mod1)

ICC = (0.07813)/(0.75515+0.07813)
ICC

r.squaredGLMM(mod1)

# Of the variance of an observation, 9.4% of this variation is the result of differences 
# between Census Tracts. 

# 90.6% of this variation is the result of differences within Census Tracts



mod2 <- lmer(atsratio ~ LogMedianIncome + Percent_Black + Percent_Renter + Percent_TotalPOPIncomeBelowPovRate + LogMedianTractSalesPrice  + PctSalePriceDiff_Above + PctSalePriceDiff_Below + (1|GEO_TRACT) + Kitchen_Excellent + Kitchen_Fair + Kitchen_Good +  Kitchen_Poor + Kitchen_VeryGood + Kitchen_VeryPoor + KITCHENS + FullBath_Excellent + FullBath_Fair + FullBath_Good + FullBath_Poor + FullBath_VeryGood + FULLBATHS + Cond_VeryPoor + Cond_Excellent + Cond_Fair + Cond_Good + Cond_Poor + Cond_VeryGood + Qual_A + Qual_B + Qual_D + Qual_E +  BEDROOMS + Cape_Cod + Milwaukee_Bungalow + Res_OS_A + Colonial + Duplex + Res_OS_2sty + Other, data = fitdata)


summary(mod2)
anova(mod2)

ICC = (0.1184)/(0.6306+0.1184)
ICC


vif(mod2)
plot(mod2)
```
 

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
