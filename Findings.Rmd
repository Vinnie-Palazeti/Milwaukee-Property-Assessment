---
title: "Findings"
output: html_document
---

Final

Research Question

Background on Dependent variable - Assessment Ratio

Data Provided
```{r}
setwd("C:/Users/Vinnie/Documents")
load("res_data_w_geo.dta")
Initial <-data.frame(res_data_w_geo)
```
All variables
```{r}
#names(Initial)
```

Continuous Variables of Interest

Sale Price, Land Size, Land Value, Improvement Value, Assessment Value
```{r}
ggplot(Initial, aes(SALEPRICE)) +
  geom_histogram(bins = 200) +
  xlab("Sale Price") + 
  ylab("Frequency")

ggplot(Initial, aes(ASSESSEDVAL)) +
  geom_histogram(bins = 200)

ggplot(Initial, aes(LANDSIZE)) +
  geom_histogram(bins = 200)

ggplot(Initial, aes(LANDVAL)) +
  geom_histogram(bins = 200)

Initial$atsratio <- Initial$ASSESSEDVAL / Initial$SALEPRICE

ggplot(Initial, aes(atsratio)) +
  geom_histogram(bins = 200)  +
  xlab("ATS Ratio") + 
  ylab("Frequency")
  

```


We first look at the main variables of interest & discover that they are all extremely right tailed.

We know from prior knowledge that this would be the case. Many weird sales/properties exist, e.g. donations, auctions, foreclosures, condemtions. 

In an attempt to remedy this we remove the observations outside the interquartile range


Look at effect of this change on distribution of ats ratio

```{r}
ggplot(resdata, aes(atsratio)) +
  geom_histogram(bins = 200) +
  xlab("ATS Ratio") + 
  ylab("Frequency")
  
ggplot(resdata, aes(log(SALEPRICE))) +
  geom_histogram(bins = 150) +
  xlab("Sale Price") + 
  ylab("Frequency")

ggplot(resdata, aes(log(ASSESSEDVAL))) +
  geom_histogram(bins = 150)

ggplot(resdata, aes(log(LANDSIZE))) +
  geom_histogram(bins = 150)
```



Categorical Variables

Building Type, Building Quality, Number of Buildings, Building Condition, Bedrooms, Kitchens, Baths, Half-Baths, Garages
```{r}
BLDFreqs <- resdata %>% group_by(BLDTYPE) %>% summarise(n = n())
plotgroup <- resdata %>% left_join(BLDFreqs, by = c("BLDTYPE"))

ggplot(filter(plotgroup, n > 400), aes(BLDTYPE)) +
  geom_bar() + 
  xlab("Building Type") + 
  ylab("Frequency")



level_order_qual <- c("A","B","C","D","E","NA")

ggplot(resdata, aes(x = factor(QUAL_recode, level = level_order_qual))) +
  geom_bar() + 
  xlab("Quality") + 
  ylab("Frequency")


level_order_cond <- c("EX - Excellent","VG - Very Good","GD - Good","AV - Average","FR - Fair","PR - Poor","VP - Very Poor","UN - Unsound")

ggplot(resdata, aes(x = factor(COND, level = level_order_cond))) +
  geom_bar()+ 
  xlab("Condition") + 
  ylab("Frequency")

ggplot(resdata, aes(NUM_BLDS)) +
  geom_bar()

ggplot(resdata, aes(KITCHENS)) +
  geom_bar()

ggplot(resdata, aes(BEDROOMS)) + 
  geom_bar()
```


Temporal Variables

Date sold, Year Built
```{r}
ggplot(resdata, aes(SALEDATE,fill = factor(QUAL_recode, level = level_order_qual))) +
  geom_histogram(bins=100) + 
  theme(legend.title=element_blank()) + 
  xlab("Sale Date & Quality") + 
  ylab("Frequency")

ggplot(resdata, aes(SALEDATE)) +
  geom_histogram(bins=100) +
  theme(legend.title=element_blank()) + 
  xlab("Sale Date") + 
  ylab("Frequency")


ggplot(resdata, aes(SALEDATE, fill = factor(atsratiodecile))) +
  geom_histogram(bins=100) +
  theme(legend.title=element_blank()) + 
  xlab("Sale Date & ATS Ratio") + 
  ylab("Frequency")

ggplot(resdata, aes(YEARBLT, fill = factor(QUAL_recode, level = level_order_qual))) +
  geom_histogram(bins=100) +
  theme(legend.title=element_blank())

ggplot(resdata, aes(YEARBLT, fill = factor(COND, level = level_order_cond))) +
  geom_histogram(bins=100)+
  theme(legend.title=element_blank())

```

Census Data

```{r}
ggplot(resdata, aes(TOTAL.POP)) + 
  geom_histogram()

ggplot(resdata, aes(MEDIAN.INCOME)) + 
  geom_histogram()


ggplot(resdata, aes(Percent_NotHispanic_White)) + 
  geom_histogram() + 
  xlab("Percent White") + 
  ylab("Frequency")

ggplot(resdata, aes(Percent_Black)) + 
  geom_histogram() + 
  xlab("Percent Black") + 
  ylab("Frequency")

ggplot(resdata, aes(Percent_Hispanic)) + 
  geom_histogram() + 
  xlab("Percent Hispanic") + 
  ylab("Frequency")

```






Visualizations of variables with ats ratio

```{r}
ggplot(resdata, aes(atsratio, fill = factor(QUAL_recode, level = level_order_qual))) +
  geom_histogram(bins=100) +
  theme(legend.title=element_blank())


ggplot(resdata, aes(atsratio, fill = factor(COND, level = level_order_cond))) +
  geom_histogram(bins=100)+
  theme(legend.title=element_blank())
```



Population analysis 

Census Data visualizations

Shapefile
```{r}
Mil_County<-st_read("C:/Users/Vinnie/Desktop/GitHub/Milwaukee-Property-Assessment/Shapefiles/Census_Tracts.shp")
#Makeup
st_geometry_type(Mil_County)
#Coordinate Reference System
st_crs(Mil_County)
#World Geodetic System 1984

`%notin%` <- Negate(`%in%`)

Mil_County2 <- Mil_County %>%
  filter(OBJECTID %notin% c(263)) %>%
  rename(GEO_TRACT = Tract_ID_I)

Mil_County3 <- st_crop(Mil_County2,xmin=-88.06995, xmax=-87.81955, ymin=42.92, ymax=43.19259)

Remove <- setdiff(Mil_County2$GEO_TRACT,resdata$GEO_TRACT)

Mil_County4 <- Mil_County3 %>% 
  left_join(resdata, by = "GEO_TRACT") %>%
  mutate(lighter = ifelse(GEO_TRACT %in% Remove, 1,0))

lighter_color <- Mil_County4 %>% filter(lighter==1)

ggplot() + 
  geom_sf(data = Mil_County4, color = "black", fill = "pink") + 
  ggtitle("Milwaukee!") + 
  coord_sf()


```


Racial population distribution

In stark relief 

```{r}
ggplot() + 
  geom_sf(aes(fill=Percent_Black), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent Black')+
  #ggtitle("Milwaukee Census Tracts by Percent Black Population") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()


ggplot() + 
  geom_sf(aes(fill=Percent_NotHispanic_White), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent White')+
  #ggtitle("Milwaukee Census Tracts by Percent White Population") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()

ggplot() + 
  geom_sf(aes(fill=Percent_Hispanic), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent Hispanic')+
  #ggtitle("Milwaukee Census Tracts by Percent Hispanic Population") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()
```

Socio-Economic Population distribution 

```{r}
ggplot() + 
  geom_sf(aes(fill=IncomeDecile), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Income Decile')+
  #ggtitle("Milwaukee Census Tracts by Income Deciles") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()


ggplot() + 
  geom_sf(aes(fill=Percent_Renter), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent Renter')+
  #ggtitle("Milwaukee Census Tracts by Percent Renter") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()

ggplot() + 
  geom_sf(aes(fill=renterdecile), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent Renter Deciles')+
  #ggtitle("Milwaukee Census Tracts by Percent Renter Deciles") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()


ggplot() + 
  geom_sf(aes(fill=Percent_TotalPOPIncomeBelowPovRate), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='Percent of in Poverty')+
  #ggtitle("Milwaukee Census Tracts by Percent Population with Income Below Poverty Rate") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()

```



```{r}

ggplot() + 
  geom_sf(aes(fill=atsratiodecile), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='ATS Ratio Decile')+
  ggtitle("Milwaukee Census Tracts by ATS Ratio Decile") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()

ggplot() + 
  geom_sf(aes(fill=atsratioMedian), color='transparent', data = Mil_County4) +
  geom_sf(fill = 'transparent', color='white', data = Mil_County4) + 
  geom_sf(fill='grey90', color = 'white',data = lighter_color)+
  scale_fill_viridis_c(name ='ATS Ratio Decile')+
  ggtitle("Milwaukee Census Tracts by ATS Ratio Decile") + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())+
  coord_sf()


```


We very plainly see patterns



Next we go into Pre Regression Analysis

First with Racial Demographics

    
Median ATS Ratio by Percent Black Population Decile
```{r}
blackpop <- tapply(resdata$atsratio,resdata$blackdecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(blackpop[[i]]['Median']) }

BlackATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(BlackATS)
tapply(resdata$atsratio,resdata$blackdecile, summary)
```

    - The Median Assessment to Sale ratio decreases as the percent black population increases
    
    - As the percent of the black population increases in a tract, the assessment diverges from the sale value of the house
    
    - Homes in black neighborhoods are under assessed 
    
    
Median ATS Ratio by Percent White Population Decile
```{r}

whitepop <- tapply(resdata$atsratio,resdata$white_nonhispanic_decile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(whitepop[[i]]['Median']) }

WhiteATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(WhiteATS)
tapply(resdata$atsratio,resdata$white_nonhispanic_decile, summary)
```

    - The Median Assessment to Sale ratio increases as the percent white population increases
    
    - As the percent of the white population increases in a tract, the assessment approaches the sale value of the house
    
    - Homes in white neighborhoods are over assessed (relative to black neighborhoods), homes are assessed closer to their true sale value
    
    - Homes in white neighborhoods show the opposite trend to black neighborhoods
    

    
Median ATS Ratio by Percent Hispanic Population Decile
```{r}
hispanicpop <- tapply(resdata$atsratio, resdata$hispaniddecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(hispanicpop[[i]]['Median']) }

HispATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(HispATS)
tapply(resdata$atsratio, resdata$hispaniddecile, summary)

```


    - See less of a trend here
    
  
Median ATS Ratio by Income Decile
```{r}
incomes <- tapply(resdata$atsratio,resdata$IncomeDecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(incomes[[i]]['Median']) }

IncomeATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)



print(IncomeATS)
tapply(resdata$atsratio,resdata$IncomeDecile, summary)
```

    - The Median Assessment to Sale ratio increases as the Median Income of the tract Increase
    
    - As the income increases, the assessment approaches the sale value of the house
    


Median ATS Ratio by Sales Decile
```{r}
sales <- tapply(resdata$atsratio,resdata$salesdecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(sales[[i]]['Median']) }

SaleATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(SaleATS)
tapply(resdata$atsratio, resdata$salesdecile, summary)

```

    - The Median Assessment to Sale ratio decreases as the sale price increases
    
    - As the sale price of a house increases, the assessment diverges from the sale value of the house
    
    - Higher prices homes are under assessed  
    
  
Median ATS Ratio by Percent Population with Income Below Poverty Rate
```{r}
pov <- tapply(resdata$atsratio,resdata$TotalPOPIncome_PovertyRateDecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(pov[[i]]['Median']) }

PovATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(PovATS)
tapply(resdata$atsratio,resdata$TotalPOPIncome_PovertyRateDecile, summary)

```

Median ATS Ratio by Percent Renter Population
```{r}
renter <- tapply(resdata$atsratio,resdata$renterdecile, summary)

medians <- c()
deciles <- 1:10
for (i in 1:10){
  medians[i] <- as.numeric(renter[[i]]['Median']) }

RentATS <- data.frame("Medians" = medians,
                       "Deciles" = deciles)

print(RentATS)
tapply(resdata$atsratio,resdata$renterdecile, summary)
```

Mann Kendall Trend Test

This is a test for monotonic trend
```{r}
cat("Black Population Deciles","\n")
MannKendall(BlackATS$Medians)
cat("---","\n")

cat("White Population Deciles","\n")
MannKendall(WhiteATS$Medians)
cat("---","\n")

cat("Hispanic Population Deciles","\n")
MannKendall(HispATS$Medians)
cat("---","\n")

cat("Income Deciles","\n")
MannKendall(IncomeATS$Medians)
cat("---","\n")

cat("Sale Price Deciles","\n")
MannKendall(SaleATS$Medians)
cat("---","\n")

cat("Renter Population Deciles","\n")
MannKendall(RentATS$Medians)
cat("---","\n")

cat("Poverty Rate Deciles","\n")
MannKendall(PovATS$Medians)
```

Black, White, Income, Sale, & Poverty are found to have Monotonic trends

Renter & Hispanic are found to not have Monotonic trends


Assessing Correlations

Consider large correlation plot of all variables needed for regression

Tract Level Variables & Observation Level Variables

Correlations
```{r}

Observation_independents <- resdata %>% 
  select(atsratio,SALEPRICE,YEARBLT,LANDSIZE, SaleYear,SaleMonth,ASSESSEDVAL, Kitchen_Average, Kitchen_Excellent, Kitchen_Fair, Kitchen_Good, Kitchen_Poor, Kitchen_VeryGood, Kitchen_VeryPoor, KITCHENS, FullBath_Average,FullBath_Excellent,FullBath_Fair,FullBath_Good,FullBath_Poor,FullBath_VeryGood,FULLBATHS, Cond_VeryPoor,Cond_Average,Cond_Excellent,Cond_Fair,Cond_Good,Cond_Poor,Cond_VeryGood, Qual_A,Qual_B,Qual_C,Qual_C,Qual_D,Qual_E, BEDROOMS, Ranch,Cape_Cod,Milwaukee_Bungalow,Res_OS_A,Colonial,Duplex,Res_OS_2sty,Other)

Obs_cors <- cor(Observation_independents)

corrplot(Obs_cors,method='circle', type = 'lower', tl.col="black")

corrplot(Obs_cors,method='circle', tl.col="black")

Tract_independents <- resdata  %>% select(GEO_TRACT,MedianATSRatio,MEDIAN.INCOME,Percent_Black,Percent_NotHispanic_White,Percent_Hispanic,Percent_TotalPOPIncomeBelowPovRate)

Tract_independents <- Tract_independents %>% 
  select(-c(GEO_TRACT)) %>%
  rename(`Median Income` = `MEDIAN.INCOME`,
         `Percent Black` = `Percent_Black`,
         `Median ATS Ratio` = `MedianATSRatio`,
         `Percent White` = `Percent_NotHispanic_White`,
         `Percent Hispanic` = `Percent_Hispanic`,
         `Percent Income Poverty` = `Percent_TotalPOPIncomeBelowPovRate`
         )

Tract_cors <- cor(Tract_independents)

corrplot(Tract_cors,method='circle', type = 'lower', tl.col="black")
```


In a crude way we can check the relationship between correlated variables via R^2

```{r}

#summary(lm(MEDIAN.INCOME ~ Percent_Black, data = resdata))
#plot(lm(MEDIAN.INCOME ~ Percent_Black, data = resdata))



ggplot(resdata, aes(x = Percent_Black, y = MEDIAN.INCOME)) +
  geom_point() +
  geom_smooth(method = lm) +
  xlab("Percent Black") +
  ylab("Median Income")



#summary(lm(MEDIAN.INCOME ~ Percent_NotHispanic_White, data = resdata))
#plot(lm(MEDIAN.INCOME ~ Percent_NotHispanic_White, data = resdata))


ggplot(resdata, aes(x = Percent_NotHispanic_White, y = MEDIAN.INCOME)) +
  geom_point() +
  geom_smooth(method = lm) +
  xlab("Percent White") +
  ylab("Median Income")




#summary(lm(MEDIAN.INCOME ~ Percent_Hispanic, data = resdata))
#plot(lm(MEDIAN.INCOME ~ Percent_NotHispanic_White, data = resdata))

ggplot(resdata, aes(x = Percent_Hispanic, y = MEDIAN.INCOME)) +
  geom_point() +
  geom_smooth(method = lm) +
  xlab("Percent Hispanic") +
  ylab("Median Income")



```


 
Regression Analysis

Quick Clean
```{r}
resdata$KITCHEN_FAC <- factor(resdata$KITCHEN_RTG)
resdata$COND_FAC <- factor(resdata$COND)
resdata$QUAL_FAC <- factor(resdata$QUAL_recode)
resdata$BATH_FAC <- factor(resdata$FULLBATH_RTG)
resdata$TYPE_FAC <- factor(resdata$BLDTYPE_recode)
resdata$PRIM_WALL <- factor(resdata$PRIM_WALL)
resdata$salemonth <- format(as.Date(resdata$SALEDATE), "%m")
resdata$saleyear <- format(as.Date(resdata$SALEDATE), "%Y")
resdata$age <- 2019 - as.numeric(resdata$YEARBLT)

```


Interpretation General Structure

```{r}
ATSRatio_stdev <- sd(resdata$atsratio)

cat("The standard deviation of assessment ratio is", ATSRatio_stdev,"\n")
cat("---","\n")


cat("In the first model we see that Log Median Tract Income has a coefficient equal to 0.1501","\n")
cat("Which is about 15% of a standard deviation","\n")
cat("---","\n")

cat("So, 15% of", ATSRatio_stdev,"is:",ATSRatio_stdev*0.15,"or 1.97%", "\n")
cat("---","\n")

cat("In other words, a neighboorhood with a one standard deviation increase in the Log Median Income is subject to a 2.22% increase in their taxable property value","\n")

cat("---","\n")

cat("This is the difference between an annual property tax bill of $1000 versus $",(1000*(ATSRatio_stdev*0.171))+1000,"\n")

```


 
Income 
```{r}
fitdata <- resdata %>% 
  select(atsratio,
         LogMedianLandSize,PctLandSizeDiff_Above, PctLandSizeDiff_Below,
         PctSalePriceDiff_Below,PctSalePriceDiff_Above,PctSalePriceDiff_Below,
         LogMedianIncome,LogMedianTractSalesPrice, MedianLandSize,age,
         GEO_TRACT)
 
scaled.dat <- fitdata %>% 
  select(-c("GEO_TRACT")) %>% scale(center = T,scale=T)

fitdata <- as.data.frame(scaled.dat) %>% 
  mutate(GEO_TRACT = fitdata$GEO_TRACT)

covariates <- resdata %>% select(KITCHEN_FAC, COND_FAC, QUAL_FAC, BATH_FAC,TYPE_FAC, KITCHENS, FULLBATHS, BEDROOMS,HALFBATH,PRIM_WALL,salemonth,saleyear,age)


fitdata <- cbind(fitdata,covariates)

mod <- lmer(atsratio ~ LogMedianIncome + LogMedianLandSize + PctLandSizeDiff_Above + PctLandSizeDiff_Below  + LogMedianTractSalesPrice  + PctSalePriceDiff_Above + PctSalePriceDiff_Below + (1|GEO_TRACT) + KITCHENS+ FULLBATHS+ HALFBATH + BEDROOMS + KITCHEN_FAC + COND_FAC + QUAL_FAC + TYPE_FAC + PRIM_WALL + salemonth + saleyear + age, data = fitdata)

summary(mod)
#vcov(mod)
anova(mod)

ICC = 0.1980/(0.1980+0.5169)
1-ICC
vif(mod)
qqnorm(resid(mod))
abline(0,1)

ggplot(data.frame(eta=predict(mod,type="link"),pearson=residuals(mod,type="pearson")),
      aes(x=eta,y=pearson)) +
  geom_point() +
  xlab("Fitted Values") + 
  ylab("Standardized Residuals") +
  theme_bw()


```
 


Black Population 
```{r}
fitdata <- resdata %>% 
  select(atsratio,
         Percent_Black,
         LogMedianLandSize,PctLandSizeDiff_Above, PctLandSizeDiff_Below,
         PctSalePriceDiff_Below,PctSalePriceDiff_Above,PctSalePriceDiff_Below,
         LogMedianIncome,LogMedianTractSalesPrice,age,
         GEO_TRACT)
 
scaled.dat <- fitdata %>% 
  select(-c("GEO_TRACT")) %>% scale(center = T,scale=T)

fitdata <- as.data.frame(scaled.dat) %>% 
  mutate(GEO_TRACT = fitdata$GEO_TRACT)

covariates <- resdata %>% select(KITCHEN_FAC, COND_FAC, QUAL_FAC, BATH_FAC,TYPE_FAC, KITCHENS, FULLBATHS, BEDROOMS,HALFBATH,PRIM_WALL,salemonth,saleyear)


fitdata <- cbind(fitdata,covariates)


mod <- lmer(atsratio ~ Percent_Black + LogMedianIncome + LogMedianLandSize + PctLandSizeDiff_Above + PctLandSizeDiff_Below  + LogMedianTractSalesPrice  + PctSalePriceDiff_Above + PctSalePriceDiff_Below + (1|GEO_TRACT) + KITCHENS+ FULLBATHS+ HALFBATH + BEDROOMS + KITCHEN_FAC + COND_FAC + QUAL_FAC + TYPE_FAC + PRIM_WALL + salemonth + saleyear + age, data = fitdata)

summary(mod)
#vcov(mod)
anova(mod)


ICC = 0.1585/(0.1585 + 0.5176)
1 - ICC
vif(mod)
qqnorm(resid(mod))
abline(0,1)

ggplot(data.frame(eta=predict(mod,type="link"),pearson=residuals(mod,type="pearson")),
      aes(x=eta,y=pearson)) +
  geom_point() +
  xlab("Fitted Values") + 
  ylab("Standardized Residuals") +
  theme_bw()


```

```{r}
ATSRatio_stdev <- sd(resdata$atsratio)

cat("The standard deviation of assessment ratio is", ATSRatio_stdev,"\n")
cat("---","\n")


cat("In this model we see that Percent Black Population has a coefficient equal to -0.2344","\n")
cat("Which is about 23% of a standard deviation","\n")
cat("---","\n")

cat("So, 23% of", ATSRatio_stdev,"is:",ATSRatio_stdev*0.233,"or 2.92%", "\n")
cat("---","\n")

cat("In other words, a neighboorhood with a one standard deviation increase in the Percent Black Population is subject to a 2.92% decrease in their taxable property value","\n")

cat("---","\n")

cat("This is the difference between an annual property tax bill of $1000 versus $",1000-(1000*(ATSRatio_stdev*0.233)),"\n")

```


Hispanic Population
```{r}
fitdata <- resdata %>% 
  select(atsratio,
         Percent_Hispanic,
         LogMedianLandSize,PctLandSizeDiff_Above, PctLandSizeDiff_Below,
         PctSalePriceDiff_Below,PctSalePriceDiff_Above,PctSalePriceDiff_Below,
         LogMedianIncome,LogMedianTractSalesPrice,age,
         GEO_TRACT)
 
scaled.dat <- fitdata %>% 
  select(-c("GEO_TRACT")) %>% scale(center = T,scale=T)

fitdata <- as.data.frame(scaled.dat) %>% 
  mutate(GEO_TRACT = fitdata$GEO_TRACT)

covariates <- resdata %>% select(KITCHEN_FAC, COND_FAC, QUAL_FAC, BATH_FAC,TYPE_FAC, KITCHENS, FULLBATHS, BEDROOMS,HALFBATH,PRIM_WALL,salemonth,saleyear)


fitdata <- cbind(fitdata,covariates)


mod <- lmer(atsratio ~ Percent_Hispanic + LogMedianIncome + LogMedianLandSize + PctLandSizeDiff_Above + PctLandSizeDiff_Below  + LogMedianTractSalesPrice  + PctSalePriceDiff_Above + PctSalePriceDiff_Below + (1|GEO_TRACT) + KITCHENS+ FULLBATHS+ HALFBATH + BEDROOMS + KITCHEN_FAC + COND_FAC + QUAL_FAC + TYPE_FAC + PRIM_WALL + salemonth + saleyear + age,data = fitdata)

summary(mod)
#vcov(mod)
anova(mod)

vif(mod)
qqnorm(resid(mod))
abline(0,1)

ggplot(data.frame(eta=predict(mod,type="link"),pearson=residuals(mod,type="pearson")),
      aes(x=eta,y=pearson)) +
  geom_point() +
  xlab("Fitted Values") + 
  ylab("Standardized Residuals") +
  theme_bw()


```
 


White Population
```{r}
fitdata <- resdata %>% 
  select(atsratio,
         Percent_NotHispanic_White,
         LogMedianLandSize,PctLandSizeDiff_Above, PctLandSizeDiff_Below,
         PctSalePriceDiff_Below,PctSalePriceDiff_Above,PctSalePriceDiff_Below,
         LogMedianIncome,LogMedianTractSalesPrice,age,
         GEO_TRACT)
 
scaled.dat <- fitdata %>% 
  select(-c("GEO_TRACT")) %>% scale(center = T,scale=T)

fitdata <- as.data.frame(scaled.dat) %>% 
  mutate(GEO_TRACT = fitdata$GEO_TRACT)

covariates <- resdata %>% select(KITCHEN_FAC, COND_FAC, QUAL_FAC, BATH_FAC,TYPE_FAC, KITCHENS, FULLBATHS, BEDROOMS,HALFBATH,PRIM_WALL,salemonth,saleyear,age)

fitdata <- cbind(fitdata,covariates)


mod <- lmer(atsratio ~ Percent_NotHispanic_White + LogMedianIncome + LogMedianLandSize + PctLandSizeDiff_Above + PctLandSizeDiff_Below  + LogMedianTractSalesPrice  + PctSalePriceDiff_Above + PctSalePriceDiff_Below + (1|GEO_TRACT) + KITCHENS+ FULLBATHS+ HALFBATH + BEDROOMS + KITCHEN_FAC + COND_FAC + QUAL_FAC + TYPE_FAC + PRIM_WALL + salemonth + saleyear + age, data = fitdata)

ICC = 0.1284/ (0.1284+0.5186)

summary(mod)
#vcov(mod)
anova(mod)

vif(mod)
qqnorm(resid(mod))
abline(0,1)

ggplot(data.frame(eta=predict(mod,type="link"),pearson=residuals(mod,type="pearson")),
      aes(x=eta,y=pearson)) +
  geom_point() +
  xlab("Fitted Values") + 
  ylab("Standardized Residuals") +
  theme_bw()

nrow(resdata)
```

```{r}
ATSRatio_stdev <- sd(resdata$atsratio)

cat("The standard deviation of assessment ratio is", ATSRatio_stdev,"\n")
cat("---","\n")


cat("In this model we see that Percent White Population has a coefficient equal to 0.3713","\n")
cat("Which is about 357% of a standard deviation","\n")
cat("---","\n")

cat("So, 37% of", ATSRatio_stdev,"is:",ATSRatio_stdev*0.3713,"or 4.86%", "\n")
cat("---","\n")

cat("In other words, a neighboorhood with a one standard deviation increase in the Percent White Population is subject to a  4.57% increase in their taxable property value","\n")

cat("---","\n")

cat("This is the difference between an annual property tax bill of $1000 versus $",1000+(1000*(ATSRatio_stdev*0.3713)),"\n")

```





 
SubPopulation Analysis 

Focus only on the neighborhoods with concentrated populations

 
 
 
 
